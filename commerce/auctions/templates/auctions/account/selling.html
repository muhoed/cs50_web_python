{% extends "auctions/account/profile_layout.html" %}

{% block content %}
{% load setflag %}
				
	{% if not user.profile_completed %}
	<div class="container m-2 bg-warning">
		<p>Your profile information is incomplete!</p>
		<p>You will not be able to buy or sell products on Auction$ till 
		all required information is not provided.</p>
		<a href="{% url 'auctions:user_profile' user.pk %}">
			Complete profile now.
		</a>
	</div>
	{% else %}
	<div class="container">
		<ul class="nav nav-tabs nav-justified">
			<li class="nav-item">
				<a class="nav-link active" data-toggle="tab" href="#active">
					Active listings
				</a>
			</li>
			<li class="nav-item">
				<a class="nav-link" data-toggle="tab" href="#sold">
					Sold items
				</a>
			</li>
			<li class="nav-item">
				<a class="nav-link" data-toggle="tab" href="#unsold">
					Unsold items
				</a>
			</li>
			<li class="nav-item">
				<a class="nav-link" data-toggle="tab" href="#products">
					Manage products
				</a>
			</li>
		</ul>
		<div class="tab-content">
			<div class="tab-pane active mt-2" id="active">
				<div class="d-flex nowrap w-100" id="tab-header">
					<h3 class="flex-grow-1">Your active listings:</h3>
					<a href="{% url 'auctions:create_listing' user.pk %}"><button class="btn btn-primary" id="create-listing-btn">
						Create new listing
					</button></a>
				</div>
				<div class="header-row mt-2 row">
					<div class="col-md-1">
						Image
					</div>
					<div class="col-md-3">
						Title
					</div>
					<div class="col-md-2">
						Categories
					</div>
					<div class="col-md-1">
						Bids count
					</div>
					<div class="col-md-2">
						Highest bid
					</div>
					<div class="col-md-2">
						Time left
					</div>
					<div class="col-md-1">
						<button class="btn btn-danger" id="cancel-all">
							Cancel all
						</button>
					</div>			
				</div>
				{% for listing in listings_list|dictsort:"end_time" %}
					{% if listing.status == "active" %}
					{% setflag %}
					<div class="listing-row row mt-1 bg-light" id="{{ listing.product.id }}">
						<div class="col-md-1 align-self-center">
							<img src="{{ listing.product.image_set.0.img_url }}">
						</div>
						<div class="col-md-3 align-self-center">
							{{ listing.product.name|capfirst }}
						</div>
						<div class="col-md-2 align-self-center">
							{% for category in listing.product.categories.all %}
								<p>{{ category.name }}</p>
							{% endfor %}
						</div>
						<div class="col-md-1 align-self-center">
							{{ listing.bids.count }}
						</div>
						<div class="col-md-2 align-self-center">
							{{ listing.max_bid }}
						</div>
						<div class="col-md-2 align-self-center">
							{{ listing.end_time|timeuntil }}
						</div>
						<div class="col-md-1 align-self-center">
							<button class="btn btn-warning" id="cancel-{{ listing.id }}">
								Cancel
							</button>
						</div>
					</div>
					
					{% endif %}
				{% empty %}
					<p>You do not list any products for sale yet.</p>
				{% endfor %}
				{% if not flag %}
					<p>You do not have active listings at the moment. <a href="{% url 'auctions:create_listing' user.pk %}">Click here</a> to create one.</p>
				{% endif %}
			</div>
			<div class="tab-pane mt-2" id="sold">
				<div class="d-flex nowrap w-100" id="tab-header">
					<h3 class="flex-grow-1">Your sold items:</h3>
					<button class="btn btn-primary" id="sold-items">
						Show stats
					</button>
				</div>
				<div class="header-row mt-2 row">
					<div class="col-md-1">
						Image
					</div>
					<div class="col-md-3">
						Title
					</div>
					<div class= "col-md-2">
						Categories
					</div>
					<div class="col-md-1">
						Bids count
					</div>
					<div class="col-md-1">
						Winning bid
					</div>
					<div class="col-md-2">
						Winner
					</div>
					<div class="col-md-2">
						Ended on
					</div>			
				</div>
				{% for listing in listings_list|dictsort:"end_time" %}
					{% if listing.winner %}
					{% setflag %}
					<div class="listing row mt-1 bg-light">
						<div class="col-md-1">
							<img src="{{ listing.product.image_set.0.img_url }}">
						</div>
						<div class="col-md-3">
							{{ listing.product.name|capfirst }}
						</div>
						<div class="col-md-2">
							{% for category in listing.product.categories.all %}
								<p>{{ category.name }}</p>
							{% endfor %}
						</div>
						<div class="col-md-1">
							{{ listing.bids.count }}
						</div>
						<div class="col-md-1">
							{{ listing.max_bid }}
						</div>
						<div class="col-md-2">
							{{ listing.winner.username }}
						</div>
						<div class="col-md-2">
							{% if listing.cancelled_on %}
								{{ listing.cancelled_on }}
							{% else %}
								{{ listing.end_time}}
							{% endif %}
						</div>
					</div>
					
					{% endif %}
				{% empty %}
					<p>You do not list any products for sale yet. <a href="{% url 'auctions:create_listing' user.pk %}">Click here</a> to sell one.</p>
				{% endfor %}
				{% if not flag %}
					<p>You did not sell any items yet. <a href="{% url 'auctions:create_listing' user.pk %}">Click here</a> to sell one.</p>
				{% endif %}
			</div>
			<div class="tab-pane mt-2" id="unsold">
				<div class="d-flex nowrap w-100" id="tab-header">
					<h3 class="flex-grow-1">Items that was not sold:</h3>
					<button class="btn btn-primary" id="unsold-items">
						Show stats
					</button>
				</div>
				<div class="row header-row mt-2">
					<div class="col-md-1">
						Image
					</div>
					<div class="col-md-3">
						Title
					</div>
					<div class= "col-md-3">
						Categories
					</div>
					<div class="col-md-2">
						Followers
					</div>
					<div class="col-md-2">
						Ended on
					</div>
					<div class="col-md-1">
						<button class="btn btn-primary" id="relist-all">
							Relist All
						</button>
					</div>				
				</div>
				{% for listing in listings_list|dictsort:"end_time" %}
					{% if listing.status != "active" and not listing.winner %}
					{% setflag %}
					<div class="listing row mt-1 bg-light">
						<div class="w-20 p-1">
							<img src="{{ listing.product.image_set.0.img_url }}">
						</div>
						<div class="col-md-3">
							{{ listing.product.name|capfirst }}
						</div>
						<div class="col-md-3">
							{% for category in listing.product.categories.all %}
								<p>{{ category.name }}</p>
							{% endfor %}
						</div>
						<div class="col-md-2">
							{{ listing.followers.count }}
						</div>
						<div class="col-md-2">
							{% if listing.cancelled_on %}
								{{ listing.cancelled_on }}
							{% else %}
								{{ listing.end_time }}
							{% endif %}
						</div>
						<div class="col-md-1">
							<button class="btn btn-secondary" id="relist">Relist</button>
						</div>
					</div>
					
					{% endif %}
				{% empty %}
					<p>You do not list any products for sale yet. <a href="{% url 'auctions:create_listing' user.pk %}">Click here</a> to sell one.</p>
				{% endfor %}
				{% if not flag %}
					<p>You do not have any ended or cancelled listings remained unsold. <a href="{% url 'auctions:create_listing' user.pk %}">Click here</a> to create new listing.</p>
				{% endif %}
			</div>
			<div class="tab-pane mt-2" id="products">
				<div class="d-flex nowrap w-100" id="tab-header">
					<h3 class="flex-grow-1">Manage products you offer:</h3>
					<button class="btn btn-primary" id="create-listing-btn">
						Add product
					</button>
				</div>
				<div class="row header-row mt-2">
					<div class="col-md-2">
						Image
					</div>
					<div class="col-md-3">
						Title
					</div>
					<div class= "col-md-2">
						Categories
					</div>
					<div class="col-md-2">
						Status
					</div>
					<div class="col-md-2">
						Num sold
					</div>
					<div class="col-md-1">
						Action
					</div>				
				</div>
				{% for product in products_list|dictsort:"created_on" %}
					<div class="row product-row mt-1 bg-light" id="{{ product.id }}">
						<div class="col-md-2 align-self-center">
							<img src="{{ product.image_set.0.img_url }}">
						</div>
						<div class="col-md-3 align-self-center">
							{{ product.name|capfirst }}
						</div>
						<div class="col-md-2 align-self-center">
							{% for category in product.categories.all %}
								<p>{{ category.name }}</p>
							{% endfor %}
						</div>
						<div class="col-md-2 align-self-center">
							{% if product.sold_num > 0 %}
							Sold
							{% elif product.listings.first %}
							Listed
							{% else %}
							Not listed 
							{% endif %}
						</div>
						<div class="col-md-2 align-self-center">
							{{ product.sold_num }}
						</div>
						<div class="col-md-1 align-self-center">
							<button class="btn btn-secondary" id="sell">Sell</button>
						</div>
					</div>
				{% empty %}
					<p>You did not add any product yet. <a href="{% url 'auctions:create_product' user.pk %}">Click here</a> to add one.</p>
				{% endfor %}
			</div>
		</div>
	</div>
	{% endif %}
	
{% endblock %}
